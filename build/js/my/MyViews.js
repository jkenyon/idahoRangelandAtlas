define(["dojo/_base/declare","my/MyMap","my/MyWidgets","esri/Map","dojo/dom","esri/views/MapView","esri/widgets/Legend","esri/layers/ImageryLayer","esri/layers/support/RasterFunction","esri/renderers/UniqueValueRenderer","esri/symbols/SimpleFillSymbol","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/symbols/SimpleMarkerSymbol","esri/layers/support/MosaicRule","esri/widgets/Search","esri/symbols/TextSymbol","esri/layers/support/LabelClass","esri/widgets/BasemapToggle","esri/tasks/QueryTask","esri/tasks/support/Query","dojo/dom-construct","dojo/dom-class","dojo/on","dojo/dom-style","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y){return a(null,{myView:null,constructor:function(){var a=new b,d=a.map;this.myView=new f({container:"mapCanvas",map:a.map,center:[-115,45.6],zoom:7});var i=this.myView,o=new c(this.myView),p=new s({view:i,nextBasemap:"satellite"}),r=new j({field:"NAME",defaultSymbol:new k({color:[255,255,255,0]})}),t=new l({url:"https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/ira_2014_county_boundaries/MapServer/0",id:"counties",outFields:["*"],opacity:.7,renderer:r,popupTemplate:{title:"{NAME}",content:"display info here"}}),z={PRIVATE:{color:"#ffffff",type:"Private"},USFS:{color:"#DDF8DE",type:"US Forest Service"},BLM:{color:"#ffe49c",type:"Bureau of Land Management"},STATEPR:{color:"#c4e5f5",type:"State Parks & Rec"},STATE:{color:"#A4C2D2",type:"State Dept. of Lands"},STATEOTH:{color:"#c4e5f5",type:"State, Other"},STATEFG:{color:"#A4C2D2",type:"State Fish & Game"},HSTRCWTR:{color:"#006CB2",type:"Unsurveyed Water"},BIA:{color:"#E9D0B7",type:"Bureau of Indian Affairs"},IR:{color:"#ffc68e",type:"American Indian Reservation"},NPS:{color:"#d9d3f4",type:"National Park Service"},NWR:{color:"#d9d000",type:"National Wildlife Refuge"},LU_USDA:{color:"#a62cd9",type:"LU_USDA"},LU_DOI:{color:"#d93629",type:"LU_DOI"},FAA:{color:"#808080",type:"FAA"},COE:{color:"#808080",type:"Corps of Engineers"},DOE:{color:"#E9D0B7",type:"Dept. of Energy"},MIL:{color:"#FBCCFE",type:"US Military"},BOR:{color:"#FFF7C9",type:"Bureau of Reclamation"},GSA:{type:"GSA"},DOI:{type:"DOI"}},A={Rangeland:{color:[255,165,0]},Wetlands:{color:[128,0,128]},Water:{color:[0,44,205]},Forest:{color:[34,139,34],totalCountyPerc:0,totalAcr:0},Developed:{color:[128,128,128]},"Cultivated Crops":{color:[255,192,203]},"Pasture/Hay":{color:[255,255,0]}},B=["Rangeland","Wetlands","Water","Forest","Developed","Cultivated Crops","Pasture/Hay"],C=[{id:0,text:"ADA"},{id:1,text:"ADAMS"},{id:2,text:"BANNOCK"},{id:3,text:"BEAR LAKE"},{id:4,text:"BENEWAH"},{id:5,text:"BINGHAM"},{id:6,text:"BLAINE"},{id:7,text:"BOISE"},{id:8,text:"BONNER"},{id:9,text:"BONNEVILLE"},{id:10,text:"BOUNDARY"},{id:11,text:"BUTTE"},{id:12,text:"CAMAS"},{id:13,text:"CANYON"},{id:14,text:"CARIBOU"},{id:15,text:"CASSIA"},{id:16,text:"CLARK"},{id:17,text:"CLEARWATER"},{id:18,text:"CUSTER"},{id:19,text:"ELMORE"},{id:20,text:"FRANKLIN"},{id:21,text:"FREMONT"},{id:22,text:"GEM"},{id:23,text:"GOODING"},{id:24,text:"IDAHO"},{id:25,text:"JEFFERSON"},{id:26,text:"JEROME"},{id:27,text:"KOOTENAI"},{id:28,text:"LATAH"},{id:29,text:"LEMHI"},{id:30,text:"LEWIS"},{id:31,text:"LINCOLN"},{id:32,text:"MADISON"},{id:33,text:"MINIDOKA"},{id:34,text:"NEZ PERCE"},{id:35,text:"ONEIDA"},{id:36,text:"OWYHEE"},{id:37,text:"PAYETTE"},{id:38,text:"POWER"},{id:39,text:"SHOSHONE"},{id:40,text:"TETON"},{id:41,text:"TWIN FALLS"},{id:42,text:"VALLEY"},{id:43,text:"WASHINGTON"}],D="https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/idaho_rangeland_atlas_201702/ImageServer",E=new h({url:D}),F="http://services.arcgis.com/WLhB60Nqwp4NnHz3/arcgis/rest/services/Kenyon_AgCensus_2012/FeatureServer/0",G=new l({url:F,id:"cows",outFields:["*"],popupTemplate:{title:"{NAME}",content:"<b>USDA Census Year:</b> {census_yea} <br /><b>Number of Ranches:</b> {Ranches_11} <br /><b>Cattle Farms:</b> {cattle_far} <br /><b>Number of Cattle:</b> {cattle_num} <br /><b>Beef Farms:</b> {beef_farms} <br /><b>Number of Beef:</b> {beef_numbe} <br />"}}),H=new g({view:i,layerInfos:[{layer:G,title:"Legend"}]}),I=new l({url:F,minScale:0,maxScale:0}),J=new l({url:F}),K=function(){i.goTo({center:[-115,45.6],zoom:7})},L=function(a,b){i.goTo({target:b,zoom:a})},M=function(b){var c,d,f="";f+='<h4 class="text-center">'+b+'</h4><table class="table table-bordered table-condensed text-center table-responsive table-fixed" cellspacing="0"><tbody>';var g=new m({symbol:new n({size:10,color:"#2e47ff",outline:{color:[255,64,0,.4],width:7}})}),h=new m({symbol:new q({color:"blue",haloColor:"black",haloSize:"1px",text:b,xoffset:3,yoffset:3,font:{size:12,family:"sans-serif",weight:"bolder"}})});G.then(function(){G.queryFeatures().then(function(a){d=a.features.filter(function(a){return a.attributes.NAME===b})}).then(function(){J.renderer=g,I.renderer=h,J.definitionExpression="NAME = '"+b+"'",I.definitionExpression="NAME = '"+b+"'",a.map.add(I),a.map.add(J),c=d[0].attributes,f+='<tr><th style="font-weight: normal;" class="text-center">USDA Census Year</th><td>'+d[0].attributes.census_yea+"</td></tr>",f+='<tr><th style="font-weight: normal;"  class="text-center">Ranches</th><td>'+d[0].attributes.Ranches_11+"</td></tr>",f+='<tr><th style="font-weight: normal;" class="text-center">Cattle Farms</th><td>'+c.cattle_far+"</td></tr>",f+='<tr><th style="font-weight: normal;" class="text-center">Number of Cattle</th><td>'+c.cattle_num+"</td></tr>",f+='<tr><th style="font-weight: normal;" class="text-center">Beef Farms</th><td>'+c.beef_farms+"</td></tr>",f+='<tr><th style="font-weight: normal;" class="text-center">Number of Beef</th><td>'+c.beef_numbe+"</td></tr>",f+="</tbody></table>",e.byId("table-div").innerHTML=f})})},N=function(b,c){var d,f,g="",h="<thead><tr><th class='header legend'></th><th class='header'>Manager</th><th data-sort='float' data-sort-default='desc' class='header default-sort text-center'>% of Rangeland</th><th class='header text-center' >% of County</th><th class='header text-center' >Acreage (acres)</th></tr></thead>",i="<thead><tr><th class='header legend'></th><th class='header text-center'>Type of Land</th><th class='header default-sort text-center' data-sort='float' data-sort-default='desc'>% of County</th><th class='header text-center' >Acreage (acres)</th></tr></thead>",j=function(a){if(null!==a&&null!==a.pixelBlock&&null!==a.pixelBlock.pixels){var b,d,e=a.pixelBlock,g=e.pixels,h=g[0],i=[],j=[],k=[],l=[],m=e.width*e.height;for(d=0;d<m;d++){var n=h[d];for(b=0;b<f.length;b++){if(n===f[b].attributes.Value){"Rangeland"!==f[b].attributes.nlcd_name?(l[d]=1,i[d]=A[f[b].attributes.nlcd_name].color[0],j[d]=A[f[b].attributes.nlcd_name].color[1],k[d]=A[f[b].attributes.nlcd_name].color[2]):"cover"===c?(l[d]=1,i[d]=A[f[b].attributes.nlcd_name].color[0],j[d]=A[f[b].attributes.nlcd_name].color[1],k[d]=A[f[b].attributes.nlcd_name].color[2]):(l[d]=1,i[d]=f[b].attributes.red,j[d]=f[b].attributes.green,k[d]=f[b].attributes.blue);break}l[d]=0,i[d]=0,j[d]=0,k[d]=0}}a.pixelBlock.pixels=[i,j,k],a.pixelBlock.statistics=null,a.pixelBlock.pixelType="U8",a.pixelBlock.mask=l}};E.pixelFilter=j,a.map.add(E),E.then(function(){var a=0;d=E.rasterAttributeTable.features;for(var e=0;e<d.length;e++)a+=d[e].attributes.area_ac;f="management"===c?d.filter(function(a,c){return a.attributes.cnty_name===b.attributes.NAME&&"Rangeland"===a.attributes.nlcd_name}):d.filter(function(a,c){return a.attributes.cnty_name===b.attributes.NAME})}).then(function(){if("management"===c)f.forEach(function(a,b){var c=a.attributes,d=z[c.sma_name].type,e=[c.red,c.green,c.blue],f="rgb("+e[0]+","+e[1]+","+e[2]+")";g+="<tr><td class='dlegend' style='background-color:"+f+";'>&nbsp;</td><td>"+d+"</td><td>"+c.per_nlcd.toFixed(2)+"</td><td>"+c.per_cnty.toFixed(2)+"</td><td>"+c.area_ac.toFixed(2)+"</td></tr>"}),e.byId("table-div").innerHTML="<h4 class='text-center'>"+b.attributes.NAME+"</h4><table id='table' class='table table-bordered table-condensed text-center table-responsive table-fixed sortable' cellspacing='0'>"+h+"<tbody>"+g+"</tbody></table>";else if("cover"===c){for(var a,d=[],j=0;j<B.length;j++)a=f.filter(function(a){return a.attributes.nlcd_name===B[j]}),d.push(a);d.forEach(function(a,b){var c=a.reduce(function(a,b){return a+b.attributes.area_ac},0),d=a.reduce(function(a,b){return a+b.attributes.per_cnty},0),e=B[b],f=A[e].color,h="rgb("+f[0]+","+f[1]+","+f[2]+")";g+="<tr><td class='dlegend' style='background-color:"+h+";'>&nbsp;</td><td>"+e.toString()+"</td><td>"+d.toFixed(2)+"</td><td>"+c.toFixed(2)+"</td></tr>"}),e.byId("table-div").innerHTML="<h4 class='text-center'>"+b.attributes.NAME+"</h4><table id='table' class='table table-bordered table-condensed text-center table-responsive table-fixed sortable' cellspacing='0'>"+i+"<tbody>"+g+"</tbody></table>"}}).then(function(){setTimeout(function(){var a=$("table.sortable").stupidtable(),b=a.find("thead th.default-sort").eq(0);b.stupidsort("desc")},1500)})};a.map.add(t);var O=o.searchWidget({view:i}),P=v.toDom('<div id="select-county"><select class="select-counties" id="select"><option value=""></option></select></div>'),Q=!1,R="",S=e.byId("land-cover"),T=e.byId("land-management"),U=e.byId("cow-management");x(S,"click",function(){K(),R="cover",i.popup.visible=!1}),x(T,"click",function(){K(),R="management",i.popup.visible=!1}),x(U,"click",function(){K(),R="cow",a.map.add(G),i.ui.add(H,"bottom-right"),i.popup.visible=!1});var V=e.byId("back-button");x(V,"click",function(){K(),R="",d.remove(E),d.remove(G),d.remove(I),d.remove(J),e.byId("table-div").innerHTML="",i.ui.remove(H),i.popup.visible=!1}),i.then(function(){i.ui.add(p,"top-right"),i.on("click",function(b){var c=new u({returnGeometry:!0,outFields:["NAME"],geometry:b.mapPoint});a.map.remove(E),t.queryFeatures(c).then(function(a){var c=a.features[0];"cow"===R?(M(c.attributes.NAME),L(7,b.mapPoint)):"management"===R?(N(c,"management"),L(9,b.mapPoint)):"cover"===R&&(N(c,"cover"),L(9,b.mapPoint))})}),i.ui.add(O,{position:"top-right",index:0}),i.ui.add(P,{position:"top-left",index:0}),$(".select-counties").select2({placeholder:"Select a county",data:C}),w.add("select-county","hidden"),e.byId("esri_widgets_Search_0").style.display="none";var b=v.toDom('<button type="button" id="fullscreen-btn" class="btn btn-info"><span class="glyphicon glyphicon-fullscreen"></span></button>');i.ui.add(b,{position:"top-right",index:0});var c=e.byId("main"),d=e.byId("mapCanvas"),f=e.byId("table-div"),g=(y.getComputedStyle(d),e.byId("map"));y.getComputedStyle(g);x(b,"click",function(a){Q===!0?(e.byId("header").style.display="block",e.byId("main-content").style.display="block",w.add(d,"map-display"),w.remove(d,"fullscreen"),w.add(c,"container-fluid"),w.add(c,"margin-top-55"),w.add(g,"container-fluid"),w.add(g,"padding-top"),i.ui.remove(f),w.remove(f,"table-dark-bg"),v.place(f,e.byId("map-menu"),"last"),Q=!1):(e.byId("header").style.display="none",e.byId("main-content").style.display="none",w.add(d,"fullscreen"),w.remove(c,"container-fluid"),w.remove(c,"margin-top-55"),w.remove(g,"container-fluid"),w.remove(g,"padding-top"),i.ui.add(f,{position:"bottom-left",index:0}),w.add(f,"table-dark-bg"),Q=!0)}),$("#select").on("select2:select",function(b){var c=b.target.selectedOptions[0].text;"cow"===R?M(c+" COUNTY"):O.search(c).then(function(b){a.map.remove(E);var c=b[0].results[0].feature;"management"===R?N(c,"management"):"cover"===R&&N(c,"cover")},function(a){console.log(a)})})})}})});